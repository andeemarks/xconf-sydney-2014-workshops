<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
	<script type="text/javascript" src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
	<script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>

<style>
		.code, .output {
			font-family: "Andale Mono", AndaleMono, monospace;
			font-size: 14px;
			padding: 20px;
			margin: 20px 0;
		}

		.code {
			background-color: #3f2a14;
			color: #fbf8f4;
		}

		.output {
			background-color: #009d00;
			color: white;
		}
	</style>	

</head> 
<body>

<div class="container">
	<div class="row">
		<div class="col-xs-10 col-xs-offset-1">
			
		 	<h1>Logstash + Grok + Elasticsearch + Kibana</h1>

			<h2>Setup log-stash-server</h2>
			<div>
				Logstash should have been installed via puppet.
				Generate SSL Certificates. We create a /ssl folder within logstash to store the created key and cert
				<div class="code">
				<b>sudo</b> mkdir /opt/logstash/ssl/
				<b>sudo</b> openssl req -x509 -batch -nodes -days 3650 -newkey rsa:2048 -keyout /opt/logstash/ssl/logstash-forwarder.key -out /opt/logstash/ssl/logstash-forwarder.crt
				</div>
				Configure logstash config file, put it in /opt/logstash
				<div class="code">
				<b>sudo</b> vim /opt/logstash/logstash-server.conf
				</div>
				Copy the content from the sample-logstash-server.conf
				Change port to some port number you want (we use 9876)
				Change ssl_certificate and ssl_key to point to the cert and private key we created earlier (/opt/logstash/ssl/logstash-forwarder.crt     and    /opt/logstash/ssl/logstash-forwarder.key)
				
				Pre-step in setting up Logstash Forwarder: copy the ssl cert we generated earlier to client app vm via /vagrant share folder. To do that, copy ssl cert to /vagrant share folder:
				<div class="code">
				cp /opt/logstash/ssl/logstash-forwarder.crt /vagrant/
				</div>

				<h4>Start Elasticserach</h4>
				<div class="code">
				<b>sudo</b> nohup /usr/share/elasticsearch/bin/elasticsearch &
				</div>
				(optional) if you want to check if ES is running: ps -ef | grep nohup
				
				<h4>Start logstash by using this command:</h4>
				<div class="code"> 
				/opt/logstash/bin/logstash -f /opt/logstash/logstash-server.conf
				</div>
				you'll be able to see output like following: 
				<div class="output">
				"Using milestone 1 input plugin 'lumberjack'. This plugin should work, but would benefit from use by folks like you. Please let us know if you find bugs or have suggestions on how to improve this plugin.  For more information on plugin milestones, see http://logstash.net/docs/1.4.2-modified/plugin-milestones {:level=>:warn}
				Using milestone 1 filter plugin 'syslog_pri'. This plugin should work, but would benefit from use by folks like you. Please let us know if you find bugs or have suggestions on how to improve this plugin.  For more information on plugin milestones, see http://logstash.net/docs/1.4.2-modified/plugin-milestones {:level=>:warn}."
				</div>
				But you will not see any output, because no service is outputting to logstash-server yet.
			</div>

			<h2>Setup Logstash Forwarder in client-app + web-service</h2>
			<div>
				(repeat these steps on each of the machine you want to gather syslog from)<br>
				Copy ssl cert from /vagrant share folder to some appropriate location
				<div class="code">
				<b>sudo</b> mkdir /opt/logstash-forwarder/ssl
				<b>sudo</b> cp /vagrant/logstash-forwarder.crt /opt/logstash-forwarder/ssl/
				</div>
				Configure Forwarder config file
				<div class="code">
				<b>sudo</b> vim /opt/logstash-forwarder/logstash-forwarder.conf
				</div>
				Copy the content from the sample forwarder.conf
				Change the ip to log-stash-server_hostname.local
				Change port to the port number you are listening to in log-stash-server (we use 9876)
				Change ssl ca to be the path that you have your cert (/opt/logstash-forwarder/ssl/logstash-forwarder.crt)
				Depending on where you want to collect the log from, in 'files', add 'paths' and 'fields' accordingly. We will add the app-log path ( eg. In web-service, log path is "/usr/bin/xconf-go-svc.log" ) and fields ( "type" => "service-log").

				<h4>Start Forwarder</h4>
				<div class="code">
				<b>sudo</b> /opt/logstash-forwarder/bin/logstash-forwarder -config /opt/logstash-forwarder/logstash-forwarder.conf
				</div>
				You should be able to see output like the following:
				<div class="output">
				"2014/08/27 13:45:36 publisher init
				2014/08/27 13:45:36 {
				  "network": {
				   â€¦.blah blah blah your config file content...

				2014/08/27 13:45:36.336504 Launching harvester on new file: /var/log/messages
				2014/08/27 13:45:36.336516 Launching harvester on new file: /var/log/secure
				2014/08/27 13:45:36.336535 Setting trusted CA from file: /opt/logstash-forwarder/ssl/logstash-forwarder.crt
				2014/08/27 13:45:36.337117 Starting harvester: /var/log/messages
				2014/08/27 13:45:36.337134 Current file offset: 99181
				2014/08/27 13:45:36.337146 Starting harvester: /var/log/secure
				2014/08/27 13:45:36.337151 Current file offset: 8123
				2014/08/27 13:45:36.441414 Connecting to 192.168.67.120:9876 (peishi-log-stash-server.local)
				2014/08/27 13:45:36.946418 Connected to 192.168.67.120 "
				</div>

			</div>

			<h2>Elasticsearch Results</h2>
			<div class="code">
				http://<your>-log-stash-server.local:9200/_search?pretty=true&size=1000
			</div>

			<h2>Kibana</h2>
			<div>
				<div class="code">
				<b>sudo</b> yum install httpd
				</div>
				In log-stash-server, make a directory for kibana tar 
				<div class="code">
				<b>sudo</b> mkdir /opt/kibana; cd /opt/kibana
				</div>
				Download the tar, and untar.
				<div class="code">
				<b>sudo</b> curl -O https://download.elasticsearch.org/kibana/kibana/kibana-3.1.0.tar.gz
				<b>sudo</b> tar zxf /opt/kibana/kibana-3.1.0.tar.gz
				</div>
				Change kibana config to use your log stash server host, and port number to 80. The reason we change it 80 is because we're going to access kibana on port 80
				<div class="code">
				<b>sudo</b> vim /opt/kibana/kibana-3.1.0/config.js
				</div>
				Search for elasticsearch: "http://"+window.location.hostname+":9200" and change the address to "http://<your>-log-stash-server.local:80"
				Copy the contents of the extracted directory to where the webserver is
				<div class="code">
				<b>sudo</b> mkdir -p /var/www/kibana3 ; <b>sudo</b> cp -R /opt/kibana/kibana-3.1.0/* /var/www/kibana3
				</div>
				notes: mkdir '-p' option will create immediate directory that dont exist
				Copy the sample kibana configuration file, and change VirtualHost name, ServerName and DocumentRoot
				<div class="code">
				<b>sudo</b> vim kibana3.conf
				</div>
				copy the content from sample-kibana.conf
				change the VirtualHost name to <your>-log-stash-server.local:80, ServerName to <your>-log-stash-server.local and DocumentRoot to where you copied your extracted kibana content to(/var/www/kibana3).
				Copy the kibana config to apache configuration folder
				<div class="code">
				<b>sudo</b> mkdir -p /etc/httpd/conf.d/ ; <b>sudo</b> cp kibana3.conf /etc/httpd/conf.d/ 
				</div>
				(optional) It is possible to generate a login credentials that will be used by kibana. The htpasswd file created will be hooked up in the kibana3.conf configuration file
				
				<b>sudo</b> htpasswd -c /etc/httpd/conf.d/kibana-htpasswd  <user>
				password
				password again

				Start apache server
				<div class="code">
				<b>sudo</b> /sbin/service httpd start
				<b>sudo</b> /sbin/service httpd status
				http://<your>-log-stash-server.local:80 
				</div>
			</div>
			</div>

<!-- Button trigger modal -->
<!-- <button class="btn btn-primary btn-lg col-xs-4 col-xs-offset-4" data-toggle="modal" data-target="#myModal"> -->
  <!-- Next -->
<!-- </button> -->
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
			<div id="image-place-holder">
			  <!-- <img class="top" src="1.png" style="width:100%" height="450"/> -->
			  <img src="http://marveltoynews.com/wp-content/uploads/2014/06/20140626-105949-e1403794981216-640x841.jpg" style="width:100%"/>
			</div>

      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



		</div>
	</div>
</div>
<br />
<br />

	<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>


</body>
</html>